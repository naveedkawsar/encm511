/*
 * My_HeaterControlCode_ASM.asm
 *
 *  Created on: Oct 10, 2016
 *      Author: aspireE15
 */
#include <blackfin.h>

	.section L1_data
	
#define INPAR1_R4 			R4
#define INPAR2_R5			R5
#define TEMP_C_R6			R6	
#define RETURN_R0 			R0
 
#define BASEADDR_P0 		P0
#define BOOST_R2 			R2
#define HEATER_REG_OFFSET	6
#define BOOST_REG_OFFSET	8
#define HEATER_WATTS_R3		R3	
	.section program
	.global _My_HeaterControlCode_ASM

_My_HeaterControlCode_ASM:
	[--SP] = R4;									//	COFFEEPOT_DEVICE *coffeePot_BaseAddress;
 	INPAR1_R4 = R0;									//		IN_PARAM1 always passed in R0
 	[--SP] = R5;									//	unsigned short int waterLevelRequired;
 	INPAR2_R5 = R1;									//		IN_PARAM2 always passed in R1
 	[--SP] = R6;
	LINK 20;
	
	[P0] = R4;
	TEMP_C_R6 = 80;
	
	.extern __Z22CurrentTemperature_CPPP16COFFEEPOT_DEVICE;
	CALL __Z22CurrentTemperature_CPPP16COFFEEPOT_DEVICE;
	
	CC = RETURN_R0 < TEMP_C_R6;
	IF CC JUMP HIGH_BOOST;
	BOOST_R2 = 2;
	JUMP ADD_HEAT;
HIGH_BOOST:
	BOOST_R2 = 5;
ADD_HEAT:
	HEATER_WATTS_R3 = 200;	
	CC = RETURN_R0 < INPAR2_R5;
	IF !CC JUMP _My_HeaterControlCode_ASM.END;
	B[BASEADDR_P0 + HEATER_REG_OFFSET] = HEATER_WATTS_R3;
	B[BASEADDR_P0 + BOOST_REG_OFFSET] = BOOST_R2;
	
	.extern __Z31My_SimulateOneSecondPassing_CPPv;
	CALL __Z31My_SimulateOneSecondPassing_CPPv;
_My_HeaterControlCode_ASM.END:
	[SP++] = R6;
	[SP++] = R5;
 	[SP++] = R4;
	UNLINK;
	RTS;